# weebi dart grpc server

## install proto tools

### Windows
choco install protoc

### WSL/Linux
```bash
# Install protoc
sudo apt-get update
sudo apt-get install -y protobuf-compiler

# Install Dart plugin for protoc
dart pub global activate protoc_plugin

# Add to PATH (add to ~/.bashrc or ~/.zshrc for permanent)
export PATH="$PATH:$HOME/.pub-cache/bin"
```

### Generate Dart code from proto files (fetches from GitHub)

**Windows PowerShell:**
```powershell
cd packages\protos\protos_weebi\tool
.\generate_protos.ps1
```

**WSL/Bash:**
```bash
cd packages/protos/protos_weebi/tool
chmod +x generate_protos.sh
./generate_protos.sh
```

### Check proto version consistency between projects

**Bash:**
```bash
chmod +x scripts/check_protos_version.sh
./scripts/check_protos_version.sh
```

in WSL
cd weebi_server
chmod +x scripts/check_protos_version.sh
./scripts/check_protos_version.sh

## generate them

cd packages/protos/protos_weebi/tool
chmod +x generate_protos.sh
./generate_protos.sh

## test it
grpcurl -proto packages\protos\proto\weebi_app_service.proto dev.weebicom:443 weebi.weebi_app.service.WeebiAppService/readAppMinimumVersion
> for more see file `_curls.md`

> for kreya (postman like) see https://github.com/weebi-com/protos
and the folder `kreya_api_calling`

## run locally

install mongosh

```shell
dart pub global activate melos
melos bootstrap
cd app/server
dart bin/server_local.dart

# in another terminal 
cd packages/protos/proto/
grpcurl -plaintext -proto fence_service.proto -d '{\"mail\": \"test@test.test\", \"password\": \"mypassword\"}' localhost:8080 weebi.fence.service.FenceService/authenticateWithCredentials
```

## run in dev/prod

```shell
$env:MONGO_DB_URI="your_mongodb_connection_string_here"
$env:PORT="8080"
$env:HTTP_PORT="8081"
dart run apps/server/bin/server.dart
```

## troubleshoot
if mongodb MongoServerSelectionError: connect ETIMEDOUT 

In Windows Defender Firewall
Go to Outbound Rules â†’ New Rule.
Select Port, click Next.
Choose TCP, specify 27017, click Next.
Select Allow the connection, click Next.
Apply to all profiles (Domain, Private, Public), click Next.
Name it something like MongoDB Outbound, click Finish.

Platform.environment : 
['PORT'] -- gRPC server port (default: 8080)
['MONGO_DB_URI']
['JWT_SECRET_KEY']
['WEEBI_EXPRESS_BASE_URL'] -- Base URL of weebi_express service (optional, e.g., http://localhost:8080)
['WEEBI_EXPRESS_JWT_SECRET_KEY'] -- JWT secret for weebi_express (optional, defaults to JWT_SECRET_KEY)

Note: HTTP REST server and email functionality has been removed from fence_service.
Email functionality is now handled by weebi_express service.
Use healthCheck gRPC method for service health and version information.