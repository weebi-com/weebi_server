syntax = "proto3";

package weebi.user.service;

import "common/g_common.proto";
import "common/mongo.proto";
import "user.proto";
import "user_permission.proto";
import "common/empty.proto";
import "boutique_chain.proto";
import "common/g_timestamp.proto";

message MailAndEncyptedPasswordRequest {
  string mail = 1;
  string passwordEncrypted = 2;
}

message UserOid {
  string oid = 1;
}

message Access {
  weebi.user.Oids chainsAccessible = 1 [json_name = 'chainsAccessible'];
  weebi.user.Oids boutiquesAccessible = 2 [json_name = 'boutiquesAccessible'];
}

message LoginRequest {
  string mail = 1;
  string password = 2;
}

message DeviceLoginRequest {
  string firmOid = 1 ;
  string chainOid = 2 ;
  string boutiqueOid = 3;
  string deviceOid = 4 ; 
  string password = 5 ;
}

message RefreshToken {
  string refreshToken = 1;
}

message Tokens {
  string accessToken = 1;
  string refreshToken = 2;
}

message UserInfo {
  string userOid = 1 [json_name = 'userOid'];
  string firmOid = 2 [json_name = 'firmOid'];
  string firstname = 3 [json_name = 'firstname'];
  string lastname = 4 [json_name = 'lastname'];
  string mail = 5 [json_name = 'mail'];
}

message UpdateDevicePasswordRequest {
  string chainOid = 1; 
  weebi.chain.Device device = 2 ;
}

service UserService {
  rpc authenticateWithCredentials (LoginRequest) returns (Tokens);
  rpc authenticateWithRefreshToken (RefreshToken) returns (Tokens);
  
  /// device management is as sensitive as user management
  rpc generateCodeForPairingDevice(weebi.common.mongo.ChainOidAndBoutiqueOid) returns (DevicePairingResponse);
  rpc addPendingDevice(PendingDeviceRequest) returns (google.retail.common.StatusResponse);
  rpc approveDevice(ApproveDeviceRequest) returns (google.retail.common.StatusResponse);

  /// weak auth hack to ease app access to cashiers with very low rights
  rpc authenticateWithDevice (DeviceLoginRequest) returns (Tokens);
  rpc updateDeviceDefaultPassword(UpdateDevicePasswordRequest) returns (google.retail.common.StatusResponse);

  /// createOne service is not meant to stay, only a shortcut to speed up MVP 
  /// TODO : splite createOne into muliple services : 
    /// update user permissions
    /// update userpassword
    /// recover userPassword
  rpc createOne(weebi.user.UserPrivate) returns (google.retail.common.StatusResponse);
  rpc readUserPermissionsByToken(weebi.common.empty.Empty) returns (weebi.user_permissions.UserPermissions);
  rpc readOne(UserOid) returns (UserInfo);
  rpc updateOne(UserInfo) returns (google.retail.common.StatusResponse);
  rpc deleteOne(UserOid) returns (google.retail.common.StatusResponse);
}

message PendingDeviceRequest {
  weebi.chain.Device device = 1 ;
  int32 code = 2;
}

message DevicePairingResponse {
  string firmOid = 1 [json_name = 'firmOid'];
  string chainOid = 2 [json_name = 'chainOid'];
  string boutiqueOid = 3 [json_name = 'boutiqueOid'];
  string userOid = 4 [json_name = 'userOid'];
  int32 code = 5 [json_name = 'code'];
  google.protobuf.Timestamp timestampUTC = 6 [json_name = 'timestampUTC'];
}

message ApproveDeviceRequest {
  weebi.common.mongo.ChainOidAndBoutiqueOid chainOidAndBoutiqueOid = 1; 
  weebi.chain.Device device = 2 ;
}
